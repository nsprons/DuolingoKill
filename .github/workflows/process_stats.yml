name: å¤„ç†è®¾å¤‡ç»Ÿè®¡æ•°æ®

on:
  issues:
    types: [opened]

jobs:
  å¤„ç†è®¾å¤‡ç»Ÿè®¡:
    if: contains(github.event.issue.labels.*.name, 'device_stats')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: read
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: å®‰è£…jqå·¥å…·
      run: sudo apt-get install -y jq

    - name: å¤„ç†ç»Ÿè®¡æ•°æ®
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        #!/bin/bash
        set -eo pipefail

        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global --add safe.directory /github/workspace

        # æå–Issueæ•°æ®
        TITLE="${{ github.event.issue.title }}"
        BODY=$(echo '${{ toJson(github.event.issue.body) }}' | jq -r '.')

        # éªŒè¯æ ‡é¢˜æ ¼å¼
        if ! [[ "$TITLE" =~ ^DeviceStats\ -\ [0-9]{4}-[0-9]{2}-[0-9]{2}\ - ]]; then
          echo "::error::æ— æ•ˆçš„é—®é¢˜æ ‡é¢˜æ ¼å¼: $TITLE"
          exit 1
        fi

        # è§£æžJSONæ•°æ®
        if ! DEVICE_ID=$(echo "$BODY" | jq -r '.device_id'); then
          echo "::error::è§£æždevice_idå¤±è´¥"
          exit 1
        fi

        DATE=$(echo "$BODY" | jq -r '.date')
        OPEN_COUNT=$(echo "$BODY" | jq -r '.open_count')
        REPORT_TIME=$(echo "$BODY" | jq -r '.report_time')
        DEVICE_MODEL=$(echo "$BODY" | jq -r '.device_model')
        ANDROID_VERSION=$(echo "$BODY" | jq -r '.android_version')
        MANUFACTURER=$(echo "$BODY" | jq -r '.manufacturer')
        SDK_VERSION=$(echo "$BODY" | jq -r '.sdk_version')

        # éªŒè¯å¿…å¡«å­—æ®µ
        REQUIRED_FIELDS=("$DEVICE_ID" "$DATE" "$OPEN_COUNT")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if [[ -z "$field" ]]; then
            echo "::error::ç¼ºå°‘å¿…è¦å­—æ®µ"
            exit 1
          fi
        done

        # å‡†å¤‡CSVæ–‡ä»¶
        CSV_FILE="stats/device_stats.csv"
        mkdir -p stats
        if [ ! -f "$CSV_FILE" ]; then
          echo "date,device_id,open_count,report_time,device_model,android_version,manufacturer,sdk_version" > "$CSV_FILE"
        fi

        # æ›´æ–°è®°å½•ï¼ˆæŒ‰è®¾å¤‡IDæ›¿æ¢ï¼‰
        TEMP_FILE=$(mktemp)
        {
          # ä¿ç•™å…¶ä»–è®¾å¤‡çš„è®°å½•
          grep -v ",$DEVICE_ID," "$CSV_FILE" || true
          # æ·»åŠ æ–°è®°å½•ï¼ˆä¼šè¦†ç›–åŒè®¾å¤‡IDçš„æ—§è®°å½•ï¼‰
          echo "\"$DATE\",\"$DEVICE_ID\",$OPEN_COUNT,\"$REPORT_TIME\",\"$DEVICE_MODEL\",\"$ANDROID_VERSION\",\"$MANUFACTURER\",$SDK_VERSION"
        } > "$TEMP_FILE" && mv "$TEMP_FILE" "$CSV_FILE"

        # æäº¤æ›´æ”¹
        git add "$CSV_FILE"
        if ! git diff-index --quiet HEAD --; then
          git commit -m "ðŸ“Š æ›´æ–°è®¾å¤‡ç»Ÿè®¡: $DEVICE_ID"
          git push origin HEAD:main
        else
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi

    - name: åˆ›å»ºæ‰§è¡Œæ‘˜è¦
      run: |
        echo "## ðŸ“ˆ è®¾å¤‡ç»Ÿè®¡å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "- å¤„ç†è®¾å¤‡: $DEVICE_ID" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰“å¼€æ¬¡æ•°: $OPEN_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- è®¾å¤‡åž‹å·: $DEVICE_MODEL" >> $GITHUB_STEP_SUMMARY
