name: Process Device Stats

on:
  issues:
    types: [opened]

jobs:
  process-device-stats:
    if: contains(github.event.issue.labels.*.name, 'device_stats')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write  # å¿…é¡»è¦æœ‰ write æƒé™æ‰èƒ½ä¿®æ”¹/å…³é—­ Issue
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up jq
        run: sudo apt-get install -y jq

      - name: Process stats data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          #!/bin/bash
          set -eo pipefail

          # å®‰å…¨è®¾ç½® Git é…ç½®
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global --add safe.directory /github/workspace

          # æå–å¹¶éªŒè¯ Issue æ•°æ®
          TITLE="${{ github.event.issue.title }}"
          BODY=$(echo '${{ toJson(github.event.issue.body) }}' | jq -r '.')

          # éªŒè¯æ ‡é¢˜æ ¼å¼
          if ! [[ "$TITLE" =~ ^DeviceStats\ -\ [0-9]{4}-[0-9]{2}-[0-9]{2}\ - ]]; then
            echo "::error::Invalid issue title format: $TITLE"
            exit 1
          fi

          # è§£æž JSON æ•°æ®
          if ! DEVICE_ID=$(echo "$BODY" | jq -r '.device_id'); then
            echo "::error::Failed to parse device_id"
            exit 1
          fi

          DATE=$(echo "$BODY" | jq -r '.date')
          OPEN_COUNT=$(echo "$BODY" | jq -r '.open_count')
          REPORT_TIME=$(echo "$BODY" | jq -r '.report_time')
          DEVICE_MODEL=$(echo "$BODY" | jq -r '.device_model')
          ANDROID_VERSION=$(echo "$BODY" | jq -r '.android_version')
          MANUFACTURER=$(echo "$BODY" | jq -r '.manufacturer')
          SDK_VERSION=$(echo "$BODY" | jq -r '.sdk_version')

          # éªŒè¯å¿…éœ€å­—æ®µ
          REQUIRED_FIELDS=("$DEVICE_ID" "$DATE" "$OPEN_COUNT")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if [[ -z "$field" ]]; then
              echo "::error::Missing required field in body"
              exit 1
            fi
          done

          # å‡†å¤‡ CSV æ–‡ä»¶
          CSV_FILE="stats/device_stats.csv"
          mkdir -p stats
          if [ ! -f "$CSV_FILE" ]; then
            echo "date,device_id,open_count,report_time,device_model,android_version,manufacturer,sdk_version" > "$CSV_FILE"
          fi

          # æ›´æ–°è®°å½•ï¼ˆåŽŸå­æ“ä½œï¼‰
          TEMP_FILE=$(mktemp)
          {
            awk -v device_id="$DEVICE_ID" -F, '
              BEGIN { OFS=FS }
              NR==1 { print; next }
              $2 != "\""device_id"\"" { print }
            ' "$CSV_FILE"
            echo "\"$DATE\",\"$DEVICE_ID\",$OPEN_COUNT,\"$REPORT_TIME\",\"$DEVICE_MODEL\",\"$ANDROID_VERSION\",\"$MANUFACTURER\",$SDK_VERSION"
          } > "$TEMP_FILE" && mv "$TEMP_FILE" "$CSV_FILE"

          # æäº¤æ›´æ”¹
          git add "$CSV_FILE"
          if ! git diff-index --quiet HEAD --; then
            git commit -m "ðŸ“Š Update stats for device $DEVICE_ID"
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi

      - name: Create summary
        run: |
          echo "## ðŸ“ˆ Device Stats Updated" >> $GITHUB_STEP_SUMMARY
          echo "- Processed data for device: $DEVICE_ID" >> $GITHUB_STEP_SUMMARY
          echo "- Open count: $OPEN_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Device model: $DEVICE_MODEL" >> $GITHUB_STEP_SUMMARY

      - name: Close and clean issue
        if: always()  # ç¡®ä¿å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿä¼šæ‰§è¡Œ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰çŽ¯å¢ƒå˜é‡
          echo "Repository: ${{ github.repository }}"
          echo "Issue Number: ${{ github.event.issue.number }}"

          # æ¸…ç©ºå¹¶å…³é—­ Issue
          RESPONSE=$(curl -s \
            -X PATCH \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{
              "title": "[Processed] Device Stats - $DEVICE_ID",
              "body": "This issue has been automatically processed and closed.\n\n" +
                      "**Processed Data**:\n" +
                      "- Device ID: $DEVICE_ID\n" +
                      "- Processed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "state": "closed"
            }')

          # è°ƒè¯•ï¼šæ˜¾ç¤º API å“åº”
          echo "API Response: $RESPONSE"

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if echo "$RESPONSE" | jq -e '.state == "closed"' > /dev/null; then
            echo "Issue #${{ github.event.issue.number }} successfully closed"
          else
            echo "::error::Failed to close issue"
            echo "$RESPONSE" | jq .
            exit 1
          fi
