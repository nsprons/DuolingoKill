<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šé¢†å›½æ€æ‰‹è®¾å¤‡ç»Ÿè®¡çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --bg-color: #f5f7fa;
            --card-bg: white;
            --text-color: #212529;
            --border-color: #e9ecef;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --chart-grid: rgba(0, 0, 0, 0.05);
            --map-tile-filter: none;
        }

        [data-theme="dark"] {
            --primary-color: #7c4dff;
            --secondary-color: #651fff;
            --accent-color: #00e5ff;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: rgba(255,255,255,0.87);
            --border-color: #333333;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --chart-grid: rgba(255,255,255,0.05);
            --map-tile-filter: invert(1) hue-rotate(180deg) brightness(0.8);
        }
        .theme-switcher {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #6c757d;
            font-weight: 300;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .data-table {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 5
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: var(--danger-color);
            font-weight: 500;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .filter-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #6c757d;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: inherit;
        }

        /* åœ°ç†ä½ç½®å¡ç‰‡æ ·å¼ */
        .geo-card {
            grid-column: span 2;
        }
        
        .map-container {
            height: 300px;
            width: 100%;
            margin-top: 15px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        /* IPä¿¡æ¯å¼¹çª— */
        .ip-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .ip-modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .ip-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ip-modal-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .ip-modal-close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .ip-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .ip-detail-item {
            margin-bottom: 10px;
        }
        
        .ip-detail-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .ip-detail-value {
            font-weight: 500;
            word-break: break-word;
        }
        
        /* æ–°å¢ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        @media (max-width: 480px) {
            .container {
                padding: 0 8px;
            }
            
            .chart-container {
                height: 180px !important;
            }
            
            .card {
                padding: 12px;
                margin: 0 -8px;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .filters {
                gap: 8px;
                padding: 12px;
            }
            
            .filter-group {
                min-width: auto;
                width: 100%;
            }
            
            .card-value {
                font-size: 1.4rem;
            }
            
            .geo-card {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
        }
        .geo-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .flag-icon {
            width: 20px;
            height: 15px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="theme-switcher" id="themeSwitcher">ğŸŒ“</div>
    <div class="container">
        <header>
            <h1>å¤šé¢†å›½æ€æ‰‹è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡</h1>
            <p class="subtitle">è¯¦ç»†è®°å½•è®¾å¤‡ä½¿ç”¨æƒ…å†µå’Œè¡Œä¸ºæ¨¡å¼</p>
        </header>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">æ—¥æœŸèŒƒå›´</label>
                <select id="dateRange">
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="30" selected>æœ€è¿‘30å¤©</option>
                    <option value="90">æœ€è¿‘90å¤©</option>
                    <option value="all">å…¨éƒ¨æ•°æ®</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">è®¾å¤‡å‹å·</label>
                <select id="deviceModel">
                    <option value="all">å…¨éƒ¨å‹å·</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Androidç‰ˆæœ¬</label>
                <select id="androidVersion">
                    <option value="all">å…¨éƒ¨ç‰ˆæœ¬</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">IPå½’å±åœ°</label>
                <select id="countryFilter">
                    <option value="all">å…¨éƒ¨å›½å®¶</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">è¿è¥å•†</label>
                <select id="ispFilter">
                    <option value="all">å…¨éƒ¨è¿è¥å•†</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">æœç´¢è®¾å¤‡ID</label>
                <input type="text" id="deviceSearch" placeholder="è¾“å…¥è®¾å¤‡ID">
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ€»å¼€å¯æ¬¡æ•°</span>
                    <span class="card-value" id="totalOpens">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="totalOpensChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ´»è·ƒè®¾å¤‡æ•°</span>
                    <span class="card-value" id="uniqueDevices">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="devicesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Androidç‰ˆæœ¬åˆ†å¸ƒ</span>
                    <span class="card-value" id="androidVersions">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="androidChart"></canvas>
                </div>
            </div>

		<div class="card geo-card">
                <div class="card-header">
                    <span class="card-title">å…¨çƒè®¾å¤‡åˆ†å¸ƒ</span>
                </div>
                <div class="map-container" id="worldMap"></div>
            </div>

            
            <div class="card geo-card">
                <div class="card-header">
                    <span class="card-title">åœ°ç†ä½ç½®åˆ†å¸ƒ</span>
                    <span class="card-value" id="uniqueLocations">--</span>
                </div>
                <div class="chart-container">
                    <canvas id="geoChart"></canvas>
                </div>
                <div class="map-container" id="mapContainer">
                    <!-- åœ°å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">è®¾å¤‡ä½¿ç”¨è¶‹åŠ¿</span>
            </div>
            <div class="chart-container" style="height: 350px;">
                <canvas id="trendChart"></canvas>
            </div>
                <div class="card-header">
                    <span class="card-title">ç½‘ç»œè¿è¥å•†åˆ†å¸ƒ</span>
                </div>
                <div class="chart-container">
                    <canvas id="ispChart"></canvas>
                </div>
        </div>
        
        <div class="data-table">
            <table id="statsTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è®¾å¤‡ID</th>
                        <th>å¼€å¯æ¬¡æ•°</th>
                        <th>è®¾å¤‡å‹å·</th>
                        <th>Androidç‰ˆæœ¬</th>
                        <th>IPåœ°å€</th>
                        <th>åœ°ç†ä½ç½®</th>
                        <th>è¿è¥å•†</th>
                        <th>åæ ‡</th>
                        <th>æ—¶åŒº</th>
                        <th>æœ€åæ´»è·ƒ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="loading">æ•°æ®åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- IPä¿¡æ¯å¼¹çª— -->
    <div class="ip-modal" id="ipModal">
        <div class="ip-modal-content">
            <div class="ip-modal-header">
                <div class="ip-modal-title">IPåœ°å€è¯¦ç»†ä¿¡æ¯</div>
                <div class="ip-modal-close" id="ipModalClose">&times;</div>
            </div>
            <div class="ip-details" id="ipDetails">
                <!-- IPè¯¦ç»†ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®å˜é‡
        let allStats = [];
        let filteredStats = [];
        let deviceModels = new Set();
        let androidVersions = new Set();
        let map = null;
        let markers = [];
        
        // åˆå§‹åŒ–å›¾è¡¨
        const totalOpensChart = initBarChart('totalOpensChart', 'æ€»å¼€å¯æ¬¡æ•°', 'rgba(67, 97, 238, 0.7)');
        const devicesChart = initDoughnutChart('devicesChart', 'è®¾å¤‡åˆ†å¸ƒ');
        const androidChart = initDoughnutChart('androidChart', 'Androidç‰ˆæœ¬åˆ†å¸ƒ');
        const geoChart = initDoughnutChart('geoChart', 'å›½å®¶åˆ†å¸ƒ');
        const trendChart = initLineChart('trendChart', 'è®¾å¤‡ä½¿ç”¨è¶‹åŠ¿');
        const ispChart = initPolarAreaChart('ispChart', 'ISPåˆ†å¸ƒ');
        
        // åŠ è½½æ•°æ®
        fetch('https://raw.githubusercontent.com/nspron/DuolingoKill/main/stats/device_stats.csv')
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                return response.text();
            })
            .then(data => {
                // æ”¹è¿›çš„CSVè§£æå‡½æ•°
                const parseCSV = (text) => {
                    const rows = text.split('\n').filter(row => row.trim() !== '');
                    const headers = rows.shift().split(',').map(h => h.replace(/^"|"$/g, ''));
                    
                    return rows.map(row => {
                        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…CSVå­—æ®µï¼ˆå¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼‰
                        const values = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                        const entry = {};
                        headers.forEach((header, i) => {
                            // ç§»é™¤å­—æ®µå€¼çš„é¦–å°¾å¼•å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            entry[header] = values[i] ? values[i].replace(/^"|"$/g, '') : '';
                        });
                        return entry;
                    });
                };

                // è§£æCSVæ•°æ®
                allStats = parseCSV(data).filter(entry => 
                    entry.date && entry.device_id && entry.open_count
                );
                
                // æ”¶é›†è®¾å¤‡å‹å·å’ŒAndroidç‰ˆæœ¬
                allStats.forEach(stat => {
                    if (stat.device_model) deviceModels.add(stat.device_model);
                    if (stat.android_version) androidVersions.add(stat.android_version);
                });
                
                // å¡«å……ç­›é€‰å™¨é€‰é¡¹
                fillFilterOptions();
                
                // åº”ç”¨åˆå§‹ç­›é€‰
                applyFilters();
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.querySelector('#statsTable tbody').innerHTML = `
                    <tr>
                        <td colspan="8", class="error">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</td>
                    </tr>
                `;
            });
        
        // ç­›é€‰å™¨äº‹ä»¶ç›‘å¬
        document.getElementById('dateRange').addEventListener('change', applyFilters);
        document.getElementById('deviceModel').addEventListener('change', applyFilters);
        document.getElementById('androidVersion').addEventListener('change', applyFilters);
        document.getElementById('deviceSearch').addEventListener('input', applyFilters);
        document.getElementById('countryFilter').addEventListener('change', applyFilters);
        document.getElementById('ispFilter').addEventListener('change', applyFilters);
        
        // IPå¼¹çª—äº‹ä»¶ç›‘å¬
        document.getElementById('ipModalClose').addEventListener('click', () => {
            document.getElementById('ipModal').style.display = 'none';
        });
        
        // ç‚¹å‡»åœ°å›¾å®¹å™¨å¤–å…³é—­å¼¹çª—
        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('ipModal')) {
                document.getElementById('ipModal').style.display = 'none';
            }
        });

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        const themeSwitcher = document.getElementById('themeSwitcher');
        themeSwitcher.addEventListener('click', () => {
            document.body.dataset.theme = document.body.dataset.theme === 'dark' ? '' : 'dark';
            // æ›´æ–°åœ°å›¾å›¾å—æ»¤é•œ
            document.querySelectorAll('.leaflet-tile').forEach(tile => {
                tile.style.filter = document.body.dataset.theme === 'dark' 
                    ? 'invert(1) hue-rotate(180deg) brightness(0.8)'
                    : '';
            });
        });
        
        // åˆå§‹åŒ–æŸ±çŠ¶å›¾
        function initBarChart(canvasId, label, color) {
            return new Chart(
                document.getElementById(canvasId),
                {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            backgroundColor: color,
                            borderColor: color.replace('0.7', '1'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${label}: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                }
            );
        }
        
        // åˆå§‹åŒ–ç¯å½¢å›¾
        function initDoughnutChart(canvasId, label) {
            return new Chart(
                document.getElementById(canvasId),
                {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            backgroundColor: [
                                'rgba(67, 97, 238, 0.7)',
                                'rgba(76, 201, 240, 0.7)',
                                'rgba(63, 55, 201, 0.7)',
                                'rgba(108, 117, 125, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            );
        }

        // åˆå§‹åŒ–æåœ°åŒºåŸŸå›¾
        function initPolarAreaChart(canvasId, label) {
            return new Chart(
                document.getElementById(canvasId),
                {
                    type: 'polarArea',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            backgroundColor: [
                                '#7c4dff', '#651fff', '#00e5ff', '#1de9b6', '#ff4081'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                }
            );
        }
        
        // åˆå§‹åŒ–æŠ˜çº¿å›¾
        function initLineChart(canvasId, label) {
            return new Chart(
                document.getElementById(canvasId),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: label,
                            data: [],
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                }
            );
        }
        
        // å¡«å……ç­›é€‰å™¨é€‰é¡¹
        function fillFilterOptions() {
            const deviceModelSelect = document.getElementById('deviceModel');
            const androidVersionSelect = document.getElementById('androidVersion');
            const countryFilter = document.getElementById('countryFilter');
            const ispFilter = document.getElementById('ispFilter');
            
            // æ·»åŠ è®¾å¤‡å‹å·é€‰é¡¹
            deviceModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                deviceModelSelect.appendChild(option);
            });
            
            // æ·»åŠ Androidç‰ˆæœ¬é€‰é¡¹
            androidVersions.forEach(version => {
                const option = document.createElement('option');
                option.value = version;
                option.textContent = `Android ${version}`;
                androidVersionSelect.appendChild(option);
            });

            // æ·»åŠ å›½å®¶å’ŒISPé€‰é¡¹
            const countries = new Set();
            const isps = new Set();
            
            allStats.forEach(stat => {
                if (stat.country) countries.add(stat.country);
                if (stat.isp) isps.add(stat.isp);
            });
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
            
            isps.forEach(isp => {
                const option = document.createElement('option');
                option.value = isp;
                option.textContent = isp;
                ispFilter.appendChild(option);
            });
        }
        
        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const deviceModel = document.getElementById('deviceModel').value;
            const androidVersion = document.getElementById('androidVersion').value;
            const deviceSearch = document.getElementById('deviceSearch').value.toLowerCase();
            const countryFilter = document.getElementById('countryFilter').value;
            const ispFilter = document.getElementById('ispFilter').value;
            
            // è®¡ç®—æ—¥æœŸèŒƒå›´
            let minDate = null;
            if (dateRange !== 'all') {
                const days = parseInt(dateRange);
                minDate = new Date();
                minDate.setDate(minDate.getDate() - days);
            }
            
            // ç­›é€‰æ•°æ®
            filteredStats = allStats.filter(stat => {
                // æ—¥æœŸç­›é€‰
                if (minDate && new Date(stat.date) < minDate) {
                    return false;
                }
                
                // è®¾å¤‡å‹å·ç­›é€‰
                if (deviceModel !== 'all' && stat.device_model !== deviceModel) {
                    return false;
                }
                
                // Androidç‰ˆæœ¬ç­›é€‰
                if (androidVersion !== 'all' && stat.android_version !== androidVersion) {
                    return false;
                }
                
                // è®¾å¤‡IDæœç´¢
                if (deviceSearch && !stat.device_id.toLowerCase().includes(deviceSearch)) {
                    return false;
                }

                // å›½å®¶ç­›é€‰
                if (countryFilter !== 'all' && stat.country !== countryFilter) {
                    return false;
                }

                // ISPç­›é€‰
                if (ispFilter !== 'all' && stat.isp !== ispFilter) {
                    return false;
                }
                
                return true;
            });
            
            // æ›´æ–°å›¾è¡¨å’Œæ•°æ®å±•ç¤º
            updateCharts();
            updateTable();
            updateVisualizations();
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts() {
            const today = new Date().toISOString().split('T')[0];
            
            // æŒ‰æ—¥æœŸèšåˆæ•°æ®
            const dailyStats = {};
            const deviceCounts = {};
            const versionCounts = {};
            const countryCounts = {};
            const ispCounts = {};
            const locationPoints = [];
            let totalOpens = 0;
            let uniqueDevices = new Set();
            let uniqueCountries = new Set();
            let uniqueLocations = new Set();
            
            filteredStats.forEach(stat => {
                // ç»Ÿè®¡æ€»å¼€å¯æ¬¡æ•°
                totalOpens += parseInt(stat.open_count) || 0;
                
                // è®°å½•å”¯ä¸€è®¾å¤‡
                uniqueDevices.add(stat.device_id);
                
                // è®°å½•å”¯ä¸€åœ°ç†ä½ç½®
                if (stat.country && stat.region && stat.city) {
                    const locationKey = `${stat.country}-${stat.region}-${stat.city}`;
                    uniqueLocations.add(locationKey);
                    
                    // è®°å½•å›½å®¶
                    uniqueCountries.add(stat.country);
                    if (!countryCounts[stat.country]) {
                        countryCounts[stat.country] = 0;
                    }
                    countryCounts[stat.country] += parseInt(stat.open_count) || 0;
                    
                    // æ”¶é›†åæ ‡ç‚¹
                    if (stat.latitude && stat.longitude) {
                        locationPoints.push({
                            lat: parseFloat(stat.latitude),
                            lng: parseFloat(stat.longitude),
                            city: stat.city,
                            region: stat.region,
                            country: stat.country,
                            count: parseInt(stat.open_count) || 1
                        });
                    }
                }

                // è®°å½•ISP
                if (stat.isp) {
                    if (!ispCounts[stat.isp]) {
                        ispCounts[stat.isp] = 0;
                    }
                    ispCounts[stat.isp] += parseInt(stat.open_count) || 0;
                }
                
                // æŒ‰æ—¥æœŸç»Ÿè®¡
                if (!dailyStats[stat.date]) {
                    dailyStats[stat.date] = 0;
                }
                dailyStats[stat.date] += parseInt(stat.open_count) || 0;
                
                // æŒ‰è®¾å¤‡ç»Ÿè®¡
                if (!deviceCounts[stat.device_model]) {
                    deviceCounts[stat.device_model] = 0;
                }
                deviceCounts[stat.device_model] += parseInt(stat.open_count) || 0;
                
                // æŒ‰Androidç‰ˆæœ¬ç»Ÿè®¡
                if (!versionCounts[stat.android_version]) {
                    versionCounts[stat.android_version] = 0;
                }
                versionCounts[stat.android_version] += parseInt(stat.open_count) || 0;
            });
            
            // æ›´æ–°ä»ªè¡¨æ¿æ•°æ®
            document.getElementById('totalOpens').textContent = totalOpens;
            document.getElementById('uniqueDevices').textContent = uniqueDevices.size;
            document.getElementById('androidVersions').textContent = Object.keys(versionCounts).length;
            document.getElementById('uniqueLocations').textContent = uniqueLocations.size;
            
            // å‡†å¤‡æ—¥æœŸæ’åº
            const dates = Object.keys(dailyStats).sort();
            
            // æ›´æ–°æ€»å¼€å¯æ¬¡æ•°å›¾è¡¨
            totalOpensChart.data.labels = dates;
            totalOpensChart.data.datasets[0].data = dates.map(date => dailyStats[date]);
            totalOpensChart.update();
            
            // æ›´æ–°è®¾å¤‡åˆ†å¸ƒå›¾è¡¨
            const topDevices = Object.entries(deviceCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            devicesChart.data.labels = topDevices.map(d => d[0] || 'æœªçŸ¥è®¾å¤‡');
            devicesChart.data.datasets[0].data = topDevices.map(d => d[1]);
            devicesChart.update();
            
            // æ›´æ–°Androidç‰ˆæœ¬åˆ†å¸ƒå›¾è¡¨
            const topVersions = Object.entries(versionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            androidChart.data.labels = topVersions.map(v => `Android ${v[0]}` || 'æœªçŸ¥ç‰ˆæœ¬');
            androidChart.data.datasets[0].data = topVersions.map(v => v[1]);
            androidChart.update();
            
            // æ›´æ–°å›½å®¶åˆ†å¸ƒå›¾è¡¨
            const topCountries = Object.entries(countryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            geoChart.data.labels = topCountries.map(c => c[0] || 'æœªçŸ¥å›½å®¶');
            geoChart.data.datasets[0].data = topCountries.map(c => c[1]);
            geoChart.update();
            
            // æ›´æ–°è¶‹åŠ¿å›¾è¡¨
            trendChart.data.labels = dates;
            trendChart.data.datasets[0].data = dates.map(date => dailyStats[date]);
            trendChart.update();
            
            // æ›´æ–°ISPå›¾è¡¨
            const topISPs = Object.entries(ispCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            ispChart.data.labels = topISPs.map(i => i[0] || 'æœªçŸ¥ISP');
            ispChart.data.datasets[0].data = topISPs.map(i => i[1]);
            ispChart.update();
            
            // æ›´æ–°åœ°å›¾
            updateMap(locationPoints);
        }

        // æ–°å¢å¯è§†åŒ–æ›´æ–°é€»è¾‘
        function updateVisualizations() {
            // æ›´æ–°ä¸–ç•Œåœ°å›¾æ ‡è®°
            if (!window.worldMap) {
                window.worldMap = L.map('worldMap', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([30.589, 114.2681], 4);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(window.worldMap);
            }

            // æ¸…é™¤æ—§æ ‡è®°
            if (window.worldMarkers) {
                window.worldMarkers.forEach(m => window.worldMap.removeLayer(m));
            }
            
            // æ·»åŠ æ–°æ ‡è®°
            window.worldMarkers = filteredStats
                .filter(s => s.latitude && s.longitude)
                .map(s => {
                    const marker = L.circleMarker([s.latitude, s.longitude], {
                        color: '#7c4dff',
                        fillColor: '#651fff',
                        radius: 5
                    }).bindPopup(`${s.city} (${s.open_count}æ¬¡)`);
                    marker.addTo(window.worldMap);
                    return marker;
                });
            
            // å¦‚æœæœ‰æ ‡è®°ï¼Œè°ƒæ•´è§†å›¾
            if (window.worldMarkers.length > 0) {
                const group = new L.featureGroup(window.worldMarkers);
                window.worldMap.fitBounds(group.getBounds());
            }
        }
        
        // æ›´æ–°åœ°å›¾
        function updateMap(locationPoints) {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = ''; // æ¸…é™¤æ—§åœ°å›¾
            
            if (locationPoints.length === 0) {
                mapContainer.innerHTML = '<div style="padding: 20px; text-align: center;">æ²¡æœ‰åœ°ç†ä½ç½®æ•°æ®</div>';
                return;
            }
            
            // è®¡ç®—ä¸­å¿ƒç‚¹
            const centerLat = locationPoints.reduce((sum, point) => sum + point.lat, 0) / locationPoints.length;
            const centerLng = locationPoints.reduce((sum, point) => sum + point.lng, 0) / locationPoints.length;
            
            // åˆå§‹åŒ–åœ°å›¾
            map = L.map('mapContainer').setView([centerLat, centerLng], 3);
            
            // æ·»åŠ åœ°å›¾å›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // æ¸…é™¤æ—§æ ‡è®°
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // æ·»åŠ æ–°æ ‡è®°
            locationPoints.forEach(point => {
                const marker = L.marker([point.lat, point.lng]).addTo(map);
                marker.bindPopup(`
                    <b>${point.city || 'æœªçŸ¥åŸå¸‚'}, ${point.region || 'æœªçŸ¥åœ°åŒº'}, ${point.country || 'æœªçŸ¥å›½å®¶'}</b><br>
                    å¼€å¯æ¬¡æ•°: ${point.count}
                `);
                markers.push(marker);
            });
            
            // å¦‚æœæœ‰å¤šä¸ªç‚¹ï¼Œè°ƒæ•´è§†å›¾ä»¥åŒ…å«æ‰€æœ‰æ ‡è®°
            if (locationPoints.length > 1) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            }
        }
        
        // æ˜¾ç¤ºIPè¯¦ç»†ä¿¡æ¯
        function showIpDetails(stat) {
            const ipModal = document.getElementById('ipModal');
            const ipDetails = document.getElementById('ipDetails');
            
            ipDetails.innerHTML = '';
            
            // æ·»åŠ IPåŸºæœ¬ä¿¡æ¯
            addIpDetail('IPåœ°å€', stat.ip_address || 'æœªçŸ¥');
            addIpDetail('å›½å®¶', stat.country || 'æœªçŸ¥');
            addIpDetail('åœ°åŒº', stat.region || 'æœªçŸ¥');
            addIpDetail('åŸå¸‚', stat.city || 'æœªçŸ¥');
            addIpDetail('ISP', stat.isp || 'æœªçŸ¥');
            addIpDetail('ç»çº¬åº¦', 
                (stat.latitude && stat.longitude) 
                    ? `${stat.latitude}, ${stat.longitude}` 
                    : 'æœªçŸ¥');
            addIpDetail('æ—¶åŒº', stat.timezone || 'æœªçŸ¥');
            
            // æ˜¾ç¤ºå¼¹çª—
            ipModal.style.display = 'flex';
            
            function addIpDetail(label, value) {
                const detailItem = document.createElement('div');
                detailItem.className = 'ip-detail-item';
                detailItem.innerHTML = `
                    <div class="ip-detail-label">${label}</div>
                    <div class="ip-detail-value">${value}</div>
                `;
                ipDetails.appendChild(detailItem);
            }
        }
        
        // æ›´æ–°è¡¨æ ¼æ•°æ®
        function updateTable() {
            const tbody = document.querySelector('#statsTable tbody');
            tbody.innerHTML = '';
            
            if (filteredStats.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</td>
                    </tr>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸé™åºæ’åº
            const sortedStats = [...filteredStats].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            // åªæ˜¾ç¤ºå‰100æ¡è®°å½•
            const displayStats = sortedStats.slice(0, 100);
            
            displayStats.forEach(stat => {
                const tr = document.createElement('tr');
                
                // æ—¥æœŸ
                const dateTd = document.createElement('td');
                dateTd.textContent = stat.date;
                tr.appendChild(dateTd);
                
                // è®¾å¤‡ID
                const deviceTd = document.createElement('td');
                deviceTd.textContent = stat.device_id.slice(0, 8) + '...';
                deviceTd.title = stat.device_id;
                tr.appendChild(deviceTd);
                
                // å¼€å¯æ¬¡æ•°
                const countTd = document.createElement('td');
                countTd.textContent = stat.open_count;
                tr.appendChild(countTd);
                
                // è®¾å¤‡å‹å·
                const modelTd = document.createElement('td');
                modelTd.textContent = stat.device_model || '--';
                tr.appendChild(modelTd);
                
                // Androidç‰ˆæœ¬
                const versionTd = document.createElement('td');
                versionTd.textContent = stat.android_version ? `Android ${stat.android_version}` : '--';
                tr.appendChild(versionTd);
                
                // IPåœ°å€
                const ipTd = document.createElement('td');
                if (stat.ip_address) {
                    const ipLink = document.createElement('a');
                    ipLink.href = '#';
                    ipLink.textContent = stat.ip_address;
                    ipLink.style.color = 'var(--primary-color)';
                    ipLink.style.textDecoration = 'none';
                    ipLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showIpDetails(stat);
                    });
                    ipTd.appendChild(ipLink);
                } else {
                    ipTd.textContent = '--';
                }
                tr.appendChild(ipTd);
                
                // åœ°ç†ä½ç½®
                const geoTd = document.createElement('td');
                if (stat.city && stat.region && stat.country) {
                    geoTd.className = 'geo-info';
                    geoTd.innerHTML = `
                        <img src="https://flagcdn.com/${stat.country.toLowerCase()}.svg" 
                             class="flag-icon" 
                             alt="${stat.country}">
                        <span>${stat.city}, ${stat.region}</span>
                    `;
                } else {
                    geoTd.textContent = '--';
                }
                tr.appendChild(geoTd);

                // åæ ‡
                const coordTd = document.createElement('td');
                if (stat.latitude && stat.longitude) {
                    coordTd.textContent = `${parseFloat(stat.latitude).toFixed(3)}, ${parseFloat(stat.longitude).toFixed(3)}`;
                } else {
                    coordTd.textContent = '--';
                }
                tr.appendChild(coordTd);
                
                // çŠ¶æ€
                const statusTd = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = 'badge ' + getStatusBadgeClass(stat.date);
                badge.textContent = getStatusText(stat.date);
                statusTd.appendChild(badge);
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            });
        }
        
        // è·å–çŠ¶æ€æ ‡ç­¾æ ·å¼
        function getStatusBadgeClass(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // æ¸…é›¶æ—¶é—´éƒ¨åˆ†ï¼Œç¡®ä¿æ¯”è¾ƒæ—¥æœŸè€Œéæ—¶é—´æˆ³
        
            const reportDate = new Date(date);
            reportDate.setHours(0, 0, 0, 0); // åŒæ ·æ¸…é›¶æ—¶é—´éƒ¨åˆ†
        
            const diffDays = Math.floor((today - reportDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'badge-success';
            } else if (diffDays <= 7) {
                return 'badge-primary';
            } else if (diffDays <= 30) {
                return 'badge-warning';
            } else {
                return 'badge-danger';
            }
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(date) {
            // ç»Ÿä¸€ç”¨æœ¬åœ°æ—¶åŒºè§£ææ—¥æœŸï¼Œé¿å… UTC å’Œæœ¬åœ°æ—¶åŒºæ··æ·†
            const today = new Date();
            today.setHours(0, 0, 0, 0); // æ¸…é›¶æ—¶é—´éƒ¨åˆ†ï¼Œç¡®ä¿æ¯”è¾ƒæ—¥æœŸè€Œéæ—¶é—´æˆ³
        
            const reportDate = new Date(date);
            reportDate.setHours(0, 0, 0, 0); // åŒæ ·æ¸…é›¶æ—¶é—´éƒ¨åˆ†
        
            const diffDays = Math.floor((today - reportDate) / (1000 * 60 * 60 * 24));
        
            if (diffDays === 0) {
                return 'ä»Šæ—¥æ´»è·ƒ';
            } else if (diffDays <= 7) {
                return '7å¤©å†…æ´»è·ƒ';
            } else if (diffDays <= 30) {
                return '30å¤©å†…æ´»è·ƒ';
            } else {
                return 'å†å²è®°å½•';
            }
        }
    </script>
</body>
</html>
